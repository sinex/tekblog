<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="shortcut icon" type="image/x-icon" href="/tekblog/assets/favicon.ico" ><!-- Begin Jekyll SEO tag v2.8.0 -->
<title>FreeIPA authentication for non-domain Samba shares | Tekblog</title>
<meta name="generator" content="Jekyll v4.2.2" />
<meta property="og:title" content="FreeIPA authentication for non-domain Samba shares" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="Original Source: https://bgstack15.wordpress.com/2017/05/10/samba-share-with-freeipa-auth/ (Archived)" />
<meta property="og:description" content="Original Source: https://bgstack15.wordpress.com/2017/05/10/samba-share-with-freeipa-auth/ (Archived)" />
<link rel="canonical" href="/tekblog/2022/04/05/samba-freeipa.html" />
<meta property="og:url" content="/tekblog/2022/04/05/samba-freeipa.html" />
<meta property="og:site_name" content="Tekblog" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2022-04-05T00:00:00+00:00" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="FreeIPA authentication for non-domain Samba shares" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"BlogPosting","dateModified":"2022-04-05T00:00:00+00:00","datePublished":"2022-04-05T00:00:00+00:00","description":"Original Source: https://bgstack15.wordpress.com/2017/05/10/samba-share-with-freeipa-auth/ (Archived)","headline":"FreeIPA authentication for non-domain Samba shares","mainEntityOfPage":{"@type":"WebPage","@id":"/tekblog/2022/04/05/samba-freeipa.html"},"url":"/tekblog/2022/04/05/samba-freeipa.html"}</script>
<!-- End Jekyll SEO tag -->
<link rel="stylesheet" href="/tekblog/assets/main.css"><link type="application/atom+xml" rel="alternate" href="/tekblog/feed.xml" title="Tekblog" /><!-- create a 'copy' button on all code snippets -->
<script type="text/javascript">
  function InitCopyPaste(){
    const codeBlocks = document.querySelectorAll("div.highlighter-rouge");
    codeBlocks.forEach((codeblock, index) => {
      const code = codeBlocks[index].innerText;
      const copyCodeButton = document.createElement("button");
      copyCodeButton.innerHTML = "Copy";
      copyCodeButton.classList = "btn btn-sm btn-outline-primary";
      copyCodeButton.onclick = function () {
        window.navigator.clipboard.writeText(code);
        copyCodeButton.innerHTML = "Copied";
        copyCodeButton.classList.add("btn-success");
        copyCodeButton.classList.remove("btn-outline-primary");
        setTimeout(() => {
          copyCodeButton.innerHTML = "Copy";
          copyCodeButton.classList.remove("btn-success");
          copyCodeButton.classList.add("btn-outline-primary");
        }, 2000);
      };
      codeblock.appendChild(copyCodeButton);
    });
  }
  document.addEventListener("DOMContentLoaded", InitCopyPaste);
</script>
<style media="screen">
  div.highlighter-rouge {
    position: relative;
  }
  div.highlighter-rouge > .highlight {
    padding-top: 10px;
  }
  div.highlighter-rouge button {
    position: absolute;
    top: 0px;
    right: 2px;
    background-color: #eef;
    border: none;
    cursor: pointer;
  }
</style><style>
    .meta-tags { margin-left: 20px; }
  </style>
</head>
<body><header class="site-header" role="banner">

  <div class="wrapper"><a class="site-title" rel="author" href="/tekblog/">Tekblog</a><nav class="site-nav">
        <input type="checkbox" id="nav-trigger" class="nav-trigger" />
        <label for="nav-trigger">
          <span class="menu-icon">
            <svg viewBox="0 0 18 15" width="18px" height="15px">
              <path d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.032C17.335,0,18,0.665,18,1.484L18,1.484z M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.032C17.335,6.031,18,6.696,18,7.516L18,7.516z M18,13.516C18,14.335,17.335,15,16.516,15H1.484 C0.665,15,0,14.335,0,13.516l0,0c0-0.82,0.665-1.483,1.484-1.483h15.032C17.335,12.031,18,12.695,18,13.516L18,13.516z"/>
            </svg>
          </span>
        </label>

        <div class="trigger"><a class="page-link" href="/tekblog/about/">About</a><a class="page-link" href="/tekblog/categories/">Categories</a><a class="page-link" href="/tekblog/tags/">Tags</a></div>
      </nav></div>
</header>
<main class="page-content" aria-label="Content">
      <div class="wrapper">
        <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title p-name" itemprop="name headline">FreeIPA authentication for non-domain Samba shares</h1>
    <p class="post-meta">
      <time class="dt-published" datetime="2022-04-05T00:00:00+00:00" itemprop="datePublished">‚è≤ Apr 5, 2022
      </time>
        <span itemprop="tags" class="meta-tags">üè∑<span itemprop="tag"><a href="/tekblog/tags/#sysadmin">sysadmin</a></span>,<span itemprop="tag"><a href="/tekblog/tags/#samba">samba</a></span>,<span itemprop="tag"><a href="/tekblog/tags/#freeipa">freeipa</a></span></span>
      
     </p>
  </header>

  <div class="post-content e-content" itemprop="articleBody">
    <p><em>Original Source: <a href="https://bgstack15.wordpress.com/2017/05/10/samba-share-with-freeipa-auth/">https://bgstack15.wordpress.com/2017/05/10/samba-share-with-freeipa-auth/</a></em> (<a href="https://web.archive.org/web/20220331111211/https://bgstack15.wordpress.com/2017/05/10/samba-share-with-freeipa-auth/">Archived</a>)</p>

<h1 id="use-freeipa-authentication-for-samba-cifs-shares-for-non-domain-windows-clients">Use FreeIPA Authentication for Samba CIFS Shares for Non-domain Windows Clients</h1>

<p>I couldn‚Äôt find a singular place on the Internet for a descriptive guide of how to configure samba to use freeipa authentication for cifs shares for non-domain Windows clients.
There are guides out there for freeipa cross-domain trust, so you can share with a domain-joined Windows client, including <a href="https://bgstack15.wordpress.com/2017/05/10/samba-share-with-freeipa-auth/">https://www.freeipa.org/page/Howto/Integrating_a_Samba_File_Server_With_IPA</a>.</p>

<p>This document will show you how to set up Samba 4.4.4 to use FreeIPA 4.4.0 usernames and passwords to allow Windows clients to connect to cifs shares.</p>

<h3 id="example-environment">Example environment:</h3>

<ul>
  <li>Freeipa domain is vm.example.com.</li>
  <li>A freeipa master on CentOS7 host1.vm.example.com 192.168.100.10</li>
  <li>A freeipa replica on CentOS7 host2.vm.example.com 192.168.100.11</li>
  <li>Samba server will go on host2.vm.examplecom.</li>
  <li>Windows client is horatio.vm.example.com.</li>
</ul>

<p><strong>update 2020-03-03</strong></p>

<p>With the information shared by Alexander NA below, by changing a few lines in smb.conf, samba 4.9.1 will work with freeipa! You need to comment out these lines:</p>

<div class="language-conf highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#domain master = Yes
#domain logons = Yes
</span></code></pre></div></div>

<p>I actually filed a bug a while ago in CentOS, but I need to go update it now.
Samba share with freeipa auth</p>

<h2 id="install-freeipa-server-and-replica">Install freeipa server (and replica)</h2>

<p>You need a working freeipa environment, which is outside the scope of this document. A quick sample installation process is:</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">### INSTALL FREEIPA host1.vm.example.com</span>

firewall-cmd <span class="nt">--permanent</span> <span class="nt">--add-service</span><span class="o">=</span>freeipa-ldap <span class="nt">--add-service</span><span class="o">=</span>freeipa-ldaps <span class="nt">--add-service</span><span class="o">=</span>ntp <span class="nt">--add-service</span><span class="o">=</span>dns <span class="nt">--add-service</span><span class="o">=</span>dhcp <span class="nt">--add-service</span><span class="o">=</span>kerberos
firewall-cmd <span class="nt">--reload</span>

yum <span class="nb">install</span> <span class="nt">-y</span> ipa-server ipa-client
ipa-server-install <span class="nt">-r</span> VM.EXAMPLE.COM <span class="nt">-n</span> vm.example.com <span class="nt">--mkhomedir</span> <span class="nt">--hostname</span><span class="o">=</span><span class="s2">"</span><span class="si">$(</span> <span class="nb">hostname</span> <span class="nt">--fqdn</span> <span class="si">)</span><span class="s2">"</span> <span class="nt">--admin-password</span><span class="o">=</span><span class="s1">'adminpassword'</span> <span class="nt">--ds-password</span><span class="o">=</span><span class="s1">'dspassword'</span>
</code></pre></div></div>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">### INSTALL REPLICA host2.vm.example.com</span>

firewall-cmd <span class="nt">--permanent</span> <span class="nt">--add-service</span><span class="o">=</span>freeipa-ldap <span class="nt">--add-service</span><span class="o">=</span>freeipa-ldaps <span class="nt">--add-service</span><span class="o">=</span>ntp <span class="nt">--add-service</span><span class="o">=</span>dns <span class="nt">--add-service</span><span class="o">=</span>dhcp <span class="nt">--add-service</span><span class="o">=</span>kerberos
firewall-cmd <span class="nt">--reload</span>

yum <span class="nb">install</span> <span class="nt">-y</span> ipa-server ipa-client
ipa-client-install <span class="nt">--mkhomedir</span> <span class="nt">--force-ntpd</span> <span class="nt">--enable-dns-updates</span>
ipa-replica-install <span class="nt">--setup-ca</span> <span class="nt">--mkhomedir</span>
</code></pre></div></div>

<h2 id="install-samba-server">Install samba server</h2>

<p>Install the samba packages.</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>yum <span class="nt">-y</span> <span class="nb">install </span>samba samba-client sssd-libwbclient
</code></pre></div></div>

<p>Create the cifs principal for samba on one of the ipa controllers.</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># run on an ipa controller. This principal name is "service/hostname"</span>
ipa service-add cifs/host2.vm.example.com
</code></pre></div></div>

<p>Fetch the keytab to the samba server. In this example, it‚Äôs the same as the replica.</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># on samba server</span>
kinit <span class="nt">-kt</span> /etc/krb5.keytab
ipa-getkeytab <span class="nt">-s</span> host1.vm.example.com <span class="nt">-p</span> cifs/host2.vm.example.com <span class="nt">-k</span> /etc/samba/samba.keytab

setsebool <span class="nt">-P</span> samba_enable_home_dirs on &amp;
</code></pre></div></div>

<p>Reference: <a href="https://bgstack15.wordpress.com/2017/05/10/samba-share-with-freeipa-auth/">https://www.freeipa.org/page/Howto/Integrating_a_Samba_File_Server_With_IPA</a></p>

<h2 id="install-adtrust-components">Install adtrust components</h2>

<h3 id="on-the-freeipa-controller">On the freeipa controller</h3>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>yum <span class="nt">-y</span> <span class="nb">install </span>ipa-server-trust-ad
ipa-adtrust-install <span class="nt">--add-sids</span>
</code></pre></div></div>

<p>I recommend running this interactively, as shown above. Let it overwrite your samba config. It will configure it to use the registry, and we will rewrite it to suit the demands here.
The ipa-adtrust-install command generates the records you need to add to dns. They will look like:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Add the following service records to your DNS server for DNS zone vm.example.com: 
_ldap._tcp.Default-First-Site-Name._sites.dc._msdcs.vm.example.com. 86400 IN SRV 0 100 389 host2.vm.example.com.
_kerberos._udp.dc._msdcs.vm.example.com. 86400 IN SRV 0 100 88 host2.vm.example.com.
_kerberos._udp.Default-First-Site-Name._sites.dc._msdcs.vm.example.com. 86400 IN SRV 0 100 88 host2.vm.example.com.
_ldap._tcp.dc._msdcs.vm.example.com. 86400 IN SRV 0 100 389 host2.vm.example.com.
_kerberos._tcp.dc._msdcs.vm.example.com. 86400 IN SRV 0 100 88 host2.vm.example.com.
_kerberos._tcp.Default-First-Site-Name._sites.dc._msdcs.vm.example.com. 86400 IN SRV 0 100 88 host2.vm.example.com.
</code></pre></div></div>

<p>I successfully added them just fine by pasting them into my zone file and running <code class="language-plaintext highlighter-rouge">rndc reconfig</code> or <code class="language-plaintext highlighter-rouge">systemctl restart named</code>.
The adtrust mechanism adds new attributes to each user and group, specifically ipaNTSecurityIdentifier (the SID) and ipaNTHash. Technically the ipaNTHash can only be generated when the user changes passwords.</p>

<p>Reference: <a href="https://bgstack15.wordpress.com/2017/05/10/samba-share-with-freeipa-auth/">https://www.redhat.com/archives/freeipa-users/2015-September/msg00052.html</a></p>

<h3 id="on-the-samba-server">On the samba server</h3>

<p>Install the <code class="language-plaintext highlighter-rouge">ipa-server-trust-ad</code> package on the samba server. You need this package there to get the ipasam config option in smb.conf.</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>yum <span class="nt">-y</span> <span class="nb">install </span>ipa-server-trust-ad
</code></pre></div></div>

<p>Open the firewall for the ports mentioned in the output of the command. You can use this script.</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">tf</span><span class="o">=</span>/lib/firewalld/services/freeipa-samba.xml
<span class="nb">touch</span> <span class="s2">"</span><span class="k">${</span><span class="nv">tf</span><span class="k">}</span><span class="s2">"</span><span class="p">;</span> <span class="nb">chmod </span>0644 <span class="s2">"</span><span class="k">${</span><span class="nv">tf</span><span class="k">}</span><span class="s2">"</span><span class="p">;</span> <span class="nb">chown </span>root:root <span class="s2">"</span><span class="k">${</span><span class="nv">tf</span><span class="k">}</span><span class="s2">"</span><span class="p">;</span> restorecon <span class="s2">"</span><span class="k">${</span><span class="nv">tf</span><span class="k">}</span><span class="s2">"</span>
<span class="nb">cat</span> <span class="o">&lt;&lt;</span><span class="no">EOFXML</span><span class="sh"> &gt; "</span><span class="k">${</span><span class="nv">tf</span><span class="k">}</span><span class="sh">"
&lt;?xml version="1.0" encoding="utf-8"?&gt;
 &lt;service&gt;
  &lt;short&gt;IPA and Samba&lt;/short&gt;
  &lt;description&gt;This service provides the ports required by the ipa-adtrust-install command.&lt;/description&gt;
  &lt;port protocol="tcp" port="135"/&gt;
  &lt;port protocol="tcp" port="138"/&gt;
  &lt;port protocol="tcp" port="139"/&gt;
  &lt;port protocol="tcp" port="445"/&gt;
  &lt;port protocol="tcp" port="1024-1300"/&gt;
  &lt;port protocol="udp" port="138"/&gt;
  &lt;port protocol="udp" port="139"/&gt;
  &lt;port protocol="udp" port="389"/&gt;
  &lt;port protocol="udp" port="445"/&gt;
 &lt;/service&gt;
</span><span class="no">EOFXML
</span>systemctl restart firewalld
firewall-cmd <span class="nt">--permanent</span> <span class="nt">--add-service</span><span class="o">=</span>freeipa-samba
firewall-cmd <span class="nt">--reload</span>
<span class="nb">echo </span><span class="k">done</span>
</code></pre></div></div>

<h2 id="allow-samba-to-read-passwords">Allow samba to read passwords</h2>

<p>This is the magic part that is so hard to find on the Internet.
You will need to give special permissions to the samba service to read user passwords.</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ipa permission-add <span class="s2">"CIFS server can read user passwords"</span> <span class="se">\</span>
   <span class="nt">--attrs</span><span class="o">={</span>ipaNTHash,ipaNTSecurityIdentifier<span class="o">}</span> <span class="se">\</span>
   <span class="nt">--type</span><span class="o">=</span>user <span class="nt">--right</span><span class="o">={</span><span class="nb">read</span>,search,compare<span class="o">}</span> <span class="nt">--bindtype</span><span class="o">=</span>permission
ipa privilege-add <span class="s2">"CIFS server privilege"</span>
ipa privilege-add-permission <span class="s2">"CIFS server privilege"</span> <span class="se">\</span>
   <span class="nt">--permission</span><span class="o">=</span><span class="s2">"CIFS server can read user passwords"</span>
ipa role-add <span class="s2">"CIFS server"</span>
ipa role-add-privilege <span class="s2">"CIFS server"</span> <span class="nt">--privilege</span><span class="o">=</span><span class="s2">"CIFS server privilege"</span>
ipa role-add-member <span class="s2">"CIFS server"</span> <span class="nt">--services</span><span class="o">=</span>cifs/host2.vm.example.com
</code></pre></div></div>

<p>Reference: <a href="https://bgstack15.wordpress.com/2017/05/10/samba-share-with-freeipa-auth/">http://freeipa-users.redhat.narkive.com/ez2uKpFS/authenticate-samba-3-or-4-with-freeipa</a></p>

<h3 id="explanation">Explanation</h3>

<p>If you use ldapsearch with kerberos authentication (after a kinit admin, of course), you can see attributes about users.</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ldapsearch <span class="nt">-Y</span> gssapi <span class="s2">"(uid=username)"</span>
</code></pre></div></div>

<p>Even if the user has generated a new password since the adtrust installation, even the admin cannot see the ipaNTHash attribute.
To confirm the samba service can read the ipaNTHash, use its keytab and search for that attribute.</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># on the samba server, so host2.vm.example.com</span>
kdestroy <span class="nt">-A</span>
kinit <span class="nt">-kt</span> /etc/samba/samba.keytab cifs/host2.vm.example.com
ldapsearch <span class="nt">-Y</span> gssapi <span class="s2">"(ipaNTHash=*)"</span> ipaNTHash
</code></pre></div></div>

<h2 id="configure-samba-to-use-freeipa-auth">Configure samba to use freeipa auth</h2>

<p>When freeipa adjusts the samba config, it will just make it use the registry backend. You can view the equivalent conf file with <code class="language-plaintext highlighter-rouge">testparm</code>.
Here is a complete /etc/samba/smb.conf:</p>

<div class="language-conf highlighter-rouge"><div class="highlight"><pre class="highlight"><code>[<span class="n">global</span>]
	<span class="n">debug</span> <span class="n">pid</span> = <span class="n">yes</span>
	<span class="n">realm</span> = <span class="n">VM</span>.<span class="n">EXAMPLE</span>.<span class="n">COM</span>
	<span class="n">workgroup</span> = <span class="n">VM</span>
	<span class="c">#domain master = Yes
</span>	<span class="n">ldap</span> <span class="n">group</span> <span class="n">suffix</span> = <span class="n">cn</span>=<span class="n">groups</span>,<span class="n">cn</span>=<span class="n">accounts</span>
	<span class="n">ldap</span> <span class="n">machine</span> <span class="n">suffix</span> = <span class="n">cn</span>=<span class="n">computers</span>,<span class="n">cn</span>=<span class="n">accounts</span>
	<span class="n">ldap</span> <span class="n">ssl</span> = <span class="n">off</span>
	<span class="n">ldap</span> <span class="n">suffix</span> = <span class="n">dc</span>=<span class="n">vm</span>,<span class="n">dc</span>=<span class="n">example</span>,<span class="n">dc</span>=<span class="n">com</span>
	<span class="n">ldap</span> <span class="n">user</span> <span class="n">suffix</span> = <span class="n">cn</span>=<span class="n">users</span>,<span class="n">cn</span>=<span class="n">accounts</span>
	<span class="n">log</span> <span class="n">file</span> = /<span class="n">var</span>/<span class="n">log</span>/<span class="n">samba</span>/<span class="n">log</span>
	<span class="n">max</span> <span class="n">log</span> <span class="n">size</span> = <span class="m">100000</span>
	<span class="c">#domain logons = Yes
</span>	<span class="n">registry</span> <span class="n">shares</span> = <span class="n">Yes</span>
	<span class="n">disable</span> <span class="n">spoolss</span> = <span class="n">Yes</span>
	<span class="n">dedicated</span> <span class="n">keytab</span> <span class="n">file</span> = <span class="n">FILE</span>:/<span class="n">etc</span>/<span class="n">samba</span>/<span class="n">samba</span>.<span class="n">keytab</span>
	<span class="n">kerberos</span> <span class="n">method</span> = <span class="n">dedicated</span> <span class="n">keytab</span>
	<span class="c">#passdb backend = ipasam:ldapi://%2fvar%2frun%2fslapd-VM-EXAMPLE-COM.socket
</span>	<span class="c">#passdb backend = ldapsam:ldapi://%2fvar%2frun%2fslapd-VM-EXAMPLE-COM.socket
</span>	<span class="n">passdb</span> <span class="n">backend</span> = <span class="n">ipasam</span>:<span class="n">ldap</span>://<span class="n">host2</span>.<span class="n">vm</span>.<span class="n">example</span>.<span class="n">com</span> <span class="n">ldap</span>://<span class="n">host1</span>.<span class="n">vm</span>.<span class="n">example</span>.<span class="n">com</span>
	<span class="n">security</span> = <span class="n">USER</span>
	<span class="n">create</span> <span class="n">krb5</span> <span class="n">conf</span> = <span class="n">No</span>
	<span class="n">rpc_daemon</span>:<span class="n">lsasd</span> = <span class="n">fork</span>
	<span class="n">rpc_daemon</span>:<span class="n">epmd</span> = <span class="n">fork</span>
	<span class="n">rpc_server</span>:<span class="n">tcpip</span> = <span class="n">yes</span>
	<span class="n">rpc_server</span>:<span class="n">netlogon</span> = <span class="n">external</span>
	<span class="n">rpc_server</span>:<span class="n">samr</span> = <span class="n">external</span>
	<span class="n">rpc_server</span>:<span class="n">lsasd</span> = <span class="n">external</span>
	<span class="n">rpc_server</span>:<span class="n">lsass</span> = <span class="n">external</span>
	<span class="n">rpc_server</span>:<span class="n">lsarpc</span> = <span class="n">external</span>
	<span class="n">rpc_server</span>:<span class="n">epmapper</span> = <span class="n">external</span>
	<span class="n">ldapsam</span>:<span class="n">trusted</span> = <span class="n">yes</span>
	<span class="n">idmap</span> <span class="n">config</span> * : <span class="n">backend</span> = <span class="n">tdb</span>

	<span class="n">ldap</span> <span class="n">admin</span> <span class="n">dn</span> = <span class="n">cn</span>=<span class="n">Directory</span> <span class="n">Manager</span>

[<span class="n">homes</span>]
	<span class="n">comment</span> = <span class="n">Home</span> <span class="n">Directories</span>
	<span class="n">valid</span> <span class="n">users</span> = %<span class="n">S</span>, %<span class="n">D</span>%<span class="n">w</span>%<span class="n">S</span>
	<span class="n">browseable</span> = <span class="n">No</span>
	<span class="n">read</span> <span class="n">only</span> = <span class="n">No</span>
	<span class="n">inherit</span> <span class="n">acls</span> = <span class="n">Yes</span>
</code></pre></div></div>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">chmod </span>0644 /etc/samba/smb.conf
<span class="nb">chown </span>root:root /etc/samba/smb.conf
restorecon /etc/samba/smb.conf
systemctl restart smb.service
</code></pre></div></div>

<h2 id="appendices">Appendices</h2>

<h3 id="get-localsid">Get localsid</h3>

<p>Get the local SID</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>net getlocalsid
</code></pre></div></div>

<h3 id="changing-ipa-domains">Changing ipa domains</h3>

<p>It‚Äôs possible that if you change ipa domains, the sssd cache is not cleared and you will have cached information for the old domain which can prevent user authentication from happening. You can just clear the cache directory manually and restart sssd.</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">rm</span> <span class="nt">-rf</span> /var/lib/sss/db/<span class="k">*</span>
systemctl restart sssd.service
</code></pre></div></div>

<p>Reference: <a href="https://bgstack15.wordpress.com/2017/05/10/samba-share-with-freeipa-auth/">https://bgstack15.wordpress.com/2017/05/07/freeipa-client-uninstall-and-reinstall/</a></p>

<h2 id="references">References</h2>

<ol>
  <li>
    <p>install samba and kerberize it:
<a href="https://sites.google.com/site/wikirolanddelepper/directory-services/ipa-server-with-samba">https://sites.google.com/site/wikirolanddelepper/directory-services/ipa-server-with-samba</a></p>
  </li>
  <li>
    <p>add cifs/servername entry:
<a href="https://www.freeipa.org/page/Howto/Integrating_a_Samba_File_Server_With_IPA">https://www.freeipa.org/page/Howto/Integrating_a_Samba_File_Server_With_IPA</a></p>
  </li>
  <li>
    <p>cifs service needs custom privilege to read password:
<a href="http://freeipa-users.redhat.narkive.com/ez2uKpFS/authenticate-samba-3-or-4-with-freeipa">http://freeipa-users.redhat.narkive.com/ez2uKpFS/authenticate-samba-3-or-4-with-freeipa</a></p>
  </li>
  <li>
    <p>Each user must generate a new password:
<a href="https://www.redhat.com/archives/freeipa-users/2015-September/msg00052.html">https://www.redhat.com/archives/freeipa-users/2015-September/msg00052.html</a></p>
  </li>
  <li>
    <p>Seminal article about freeipa and samba integration:
<a href="https://techslaves.org/2011/08/24/freeipa-and-samba-3-integration/">https://techslaves.org/2011/08/24/freeipa-and-samba-3-integration/</a></p>
  </li>
  <li>
    <p>Changing ipa domains:
<a href="https://bgstack15.wordpress.com/2017/05/07/freeipa-client-uninstall-and-reinstall/">https://bgstack15.wordpress.com/2017/05/07/freeipa-client-uninstall-and-reinstall/</a></p>
  </li>
</ol>

  </div><a class="u-url" href="/tekblog/2022/04/05/samba-freeipa.html" hidden></a>
</article>



      </div>
    </main><footer class="site-footer h-card">
  <data class="u-url" href="/tekblog/"></data>

  <div class="wrapper">

    <h2 class="footer-heading">Tekblog</h2>

    <div class="footer-col-wrapper">
      <div class="footer-col footer-col-1">
        <ul class="contact-list">
          <li class="p-name">Tekblog</li></ul>
      </div>

      <div class="footer-col footer-col-2"><ul class="social-media-list"></ul>
</div>

      <div class="footer-col footer-col-3">
        <p>Snippets from the world of IT &amp; Software Engineering</p>
      </div>
    </div>

  </div>

</footer>
</body>

</html>
